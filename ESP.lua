local ESPHolder = game.CoreGui:FindFirstChild("ESPHolder") or Instance.new("Folder")

local function updateESP()
    for _, existingESP in ipairs(ESPHolder:GetChildren()) do
        existingESP:Destroy()
    end

    for _, player in pairs(game.Players:GetPlayers()) do
        if player ~= game.Players.LocalPlayer then
            local character = player.Character or player.CharacterAdded:Wait()
            createESP(player, character)
        end
    end
end

if not enabled then
    ESPHolder:Destroy()
end

if ESPHolder.Name ~= "ESPHolder" then
    ESPHolder.Name = "ESPHolder"
    ESPHolder.Parent = game.CoreGui
end

if not uselocalplayer and ESPHolder:FindFirstChild(game.Players.LocalPlayer.Name) then
    ESPHolder:FindFirstChild(game.Players.LocalPlayer.Name):Destroy()
end

if getgenv().enabled then
    getgenv().enabled = false
    getgenv().enabled = true
end

local function createESP(player, character)
    local displayName = player.Name.."|"..character:WaitForChild("Humanoid").Health.."|"
    local holdingTool = character:WaitForChild("Backpack"):FindFirstChild("Tool") or "No Tool"
    displayName = displayName..(holdingTool and holdingTool.Name or "No Tool")

    local text = Drawing.new("Text")
    text.Visible = false
    text.Center = true
    text.Outline = false 
    text.Font = 3
    text.Size = 16.16
    text.Color = Color3.new(170, 170, 170)

    local function disconnect()
        text.Visible = false
        text:Remove()
        if connection then
            connection:Disconnect()
            connection = nil 
        end
        if connection2 then
            connection2:Disconnect()
            connection2 = nil 
        end
        if connection3 then
            connection3:Disconnect()
            connection3 = nil 
        end
    end

    local connection, connection2, connection3

    connection2 = character.AncestryChanged:Connect(function(_, parent)
        if not parent then
            disconnect()
        end
    end)

    connection3 = character:WaitForChild("Humanoid").HealthChanged:Connect(function(v)
        if v <= 0 or character:WaitForChild("Humanoid"):GetState() == Enum.HumanoidStateType.Dead then
            disconnect()
        end
    end)

    connection = game:GetService("RunService").RenderStepped:Connect(function()
        local hrpPos, hrpOnScreen = game.Workspace.CurrentCamera:WorldToViewportPoint(character.Head.Position)
        if hrpOnScreen then
            text.Position = Vector2.new(hrpPos.X, hrpPos.Y - 27)
            text.Text = displayName
            text.Visible = true
        else
            text.Visible = false
        end
        wait(0.073)
    end)

    ESPHolder:WaitForChild(player.Name).Parent = nil
    ESPHolder:WaitForChild(player.Name).Parent = ESPHolder
end

game:GetService("Players").PlayerAdded:Connect(function(player)
    if player ~= game.Players.LocalPlayer then
        createESP(player, player.Character or player.CharacterAdded:Wait())
        player.CharacterAdded:Connect(function(character)
            createESP(player, character)
        end)
    end
    updateESP()
end)

game:GetService("Players").PlayerRemoving:Connect(function(player)
    ESPHolder:WaitForChild(player.Name):Destroy()
    updateESP()
end)
